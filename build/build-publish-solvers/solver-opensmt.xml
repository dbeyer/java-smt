<?xml version="1.0" encoding="UTF-8" ?>

<!--
This file is part of JavaSMT,
an API wrapper for a collection of SMT solvers:
https://github.com/sosy-lab/java-smt

SPDX-FileCopyrightText: 2025 Dirk Beyer <https://www.sosy-lab.org>

SPDX-License-Identifier: Apache-2.0
-->

<!-- vim: set tabstop=8 shiftwidth=4 expandtab sts=4 filetype=ant fdm=marker: -->
<project name="publish-solvers-opensmt" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

    <property name="opensmt.dist.dir" value="${ivy.solver.dist.dir}/opensmt"/>

    <import file="macros.xml"/>

    <target name="set-properties-for-opensmt">
        <checkPathOption pathOption="opensmt.path" defaultPath="/path/to/opensmt" targetName="OpenSMT source folder (git checkout from 'https://github.com/usi-verification-and-security/opensmt.git)"/>
        <fail unless="opensmt.customRev">
            Please specify a custom revision with the flag -Dopensmt.customRev=XXX.
            The custom revision has to be unique amongst the already known version
            numbers from the ivy repository. The script will append the git revision.
        </fail>

        <!-- Get a naive version -->
        <exec executable="git" dir="${opensmt.path}" outputproperty="opensmt.revision" failonerror="true">
            <arg value="show"/>
            <arg value="-s"/>
            <arg value="--format=%h"/>
        </exec>
        <property name="opensmt.version" value="${opensmt.customRev}-g${opensmt.revision}"/>
        <echo message="Building OpenSMT in version '${opensmt.version}'"/>

        <!-- set properties for the next steps -->
        <property name="opensmt.version" value="${opensmt.customRev}-g${opensmt.revision}"/>
        <property name="opensmt.installPath" location="${opensmt.path}/install"/>
        <property name="source.path" location="lib/native/source/opensmt"/>
        <property name="source.installPathLinuxX64" location="${source.path}/install-linux-x64"/>

        <!-- cleanup target directories, will be created and filled during the build-process -->
        <delete dir="${source.installPathLinuxX64}" quiet="true"/>
        <delete dir="${source.path}/build" quiet="true"/>
        <delete dir="${source.path}/doc" quiet="true"/>
        <delete dir="${source.path}/install" quiet="true"/>
    </target>

    <target name="compile-opensmt-linux-x64" depends="set-properties-for-opensmt">
        <delete dir="${opensmt.installPath}" quiet="true"/>
        <echo message="Building OpenSMT in version '${opensmt.version}' for Linux x64"/>

        <!-- Patch OpenSMT to avoid swig errors and add some required features -->
        <exec executable="git" dir="${opensmt.path}" failonerror="true">
            <arg value="apply"/>
            <arg value="${source.path}/api.patch"/>
        </exec>

        <!-- Build OpenSMT -->
        <exec executable="make" dir="${opensmt.path}" failonerror="true">
            <arg value="INSTALL_DIR=${opensmt.installPath}"/>
            <arg value="CMAKE_FLAGS=-DFORCE_STATIC_GMP=ON"/>
            <arg value="install"/>
        </exec>

        <!-- Revert the patch -->
        <exec executable="git" dir="${opensmt.path}" failonerror="true">
            <arg value="apply"/>
            <arg value="-R"/>
            <arg value="${source.path}/api.patch"/>
        </exec>

        <!-- copy OpenSMT include files to JavaSMT -->
        <copy todir="${source.installPathLinuxX64}">
            <fileset dir="${opensmt.installPath}"/>
        </copy>
    </target>

    <!-- Run swig to generate a new wrapper. -->
    <!-- Depends on compile-opensmt-* for generating the API files. -->
    <target name="build-opensmt-wrapper" depends="compile-opensmt-linux-x64">
        <!--
            This ant-step uses the Linux x64 dependencies for building the SWIG-wrapper.
            Any other dependencies, e.g., Windows or Linux for other platforms, are identical
            and would also work. However, the Linux x64 path is hardcoded here.
        -->

        <!-- create output directory for the swig proxies -->
        <delete dir="${source.path}/src" quiet="true"/>
        <mkdir dir="${source.path}/src/org/sosy_lab/java_smt/solvers/opensmt/api"/>

        <!-- run swig to generate java files and the c wrapper -->
        <exec executable="swig" dir="${source.path}" failonerror="true">
            <arg value="-java"/>
            <arg value="-c++"/>
            <arg value="-werror"/>
            <arg value="-I${source.installPathLinuxX64}"/>
            <arg value="-package"/>
            <arg value="org.sosy_lab.java_smt.solvers.opensmt.api"/>
            <arg value="-outdir"/>
            <arg value="src/org/sosy_lab/java_smt/solvers/opensmt/api"/>
            <arg value="-o"/>
            <arg value="opensmt-wrap.cpp"/>
            <arg value="swig/opensmt.i"/>
        </exec>

        <!-- Apply the patch to add the license headers -->
        <exec executable="git" failonerror="true">
            <arg value="apply"/>
            <arg value="${source.path}/swigWrapper.patch"/>
        </exec>
    </target>

    <target name="build-opensmt-bindings-jni" depends="build-opensmt-wrapper">
        <!-- compile java proxies and create jar file -->
        <mkdir dir="${source.path}/build"/>
        <javac release="11" srcdir="${source.path}/src/" destdir="${source.path}/build" includeantruntime="false" failonerror="true">
            <include name="org/sosy_lab/java_smt/solvers/opensmt/api/*.java"/>
        </javac>
        <jar destfile="${opensmt.dist.dir}/opensmt-${opensmt.version}.jar" basedir="${source.path}/build"/>

        <!-- generate and package javadoc documentation -->
        <mkdir dir="${source.path}/doc"/>
        <javadoc sourcepath="${source.path}/src" destdir="${source.path}/doc"/>
        <jar destfile="${opensmt.dist.dir}/opensmt-${opensmt.version}-javadoc.jar" basedir="${source.path}/doc"/>

        <!-- package swig generated source code -->
        <jar destfile="${opensmt.dist.dir}/opensmt-${opensmt.version}-sources.jar" basedir="${source.path}/src"/>
    </target>

    <target name="build-opensmt-bindings-linux-x64" depends="build-opensmt-bindings-jni">
        <!-- Dump ${opensmt.version} to a file so that we can use it for the swig wrapper -->
        <echo file="${source.path}/version.h">#define VERSION "${opensmt.version}"</echo>

        <!-- compile the swig wrapper -->
        <exec executable="gcc" dir="${source.path}" failonerror="true">
            <arg value="-fPIC"/>
            <arg value="-std=c++20"/>
            <arg value="-c"/>
            <arg value="opensmt-wrap.cpp"/>
            <arg value="-I${source.installPathLinuxX64}/include"/>
            <arg value="-I${source.installPathLinuxX64}/include/opensmt"/>
            <arg value="-I${java.home}/include"/>
            <arg value="-I${java.home}/include/linux"/>
        </exec>

        <!-- link the wrapper to create libopensmtj-x64.so -->
        <!-- Licensing:
             GMP is licensed under LGPL:
              - https://www.gnu.org/licenses/lgpl-3.0.html
             OpenSMT is licensed under MIT license:
              - https://github.com/opensmt/opensmt/blob/main/COPYING
             Based on that information, we provide the whole library including its dependencies under the MIT license.
        -->
        <!-- Link the wrapper and create a new lib -->
        <exec executable="gcc" dir="${source.path}" failonerror="true">
            <arg value="-shared"/>
            <arg value="-o"/>
            <arg value="libopensmtjava-x64.so"/>
            <arg value="opensmt-wrap.o"/>
            <arg value="-lstdc++"/>
            <arg value="-Wl,--whole-archive"/>
            <arg value="${source.installPathLinuxX64}/lib/libopensmt.a"/>
            <arg value="/dependencies/gmp-6.2.1/.libs/libgmp.a"/>
            <arg value="/dependencies/gmp-6.2.1/.libs/libgmpxx.a"/>
            <arg value="-Wl,--no-whole-archive"/>
            <arg value="-lm"/>
            <arg value="-Wl,-z,defs"/>
        </exec>

        <exec executable="strip" dir="${source.path}" failonerror="true">
            <arg value="libopensmtjava-x64.so"/>
        </exec>
    </target>

    <target name="build-opensmt-linux-x64"
            depends="compile-opensmt-linux-x64, build-opensmt-wrapper, build-opensmt-bindings-linux-x64">
    </target>

    <target name="publish-opensmt"
            depends="build-opensmt-linux-x64, load-ivy"
            description="Publish OpenSMT binaries to Ivy repository.">
        <!-- copy library files into directory to be published for Ivy -->
        <copy file="${source.path}/libopensmtjava-x64.so" tofile="${opensmt.dist.dir}/x64/libopensmtjava-${opensmt.version}.so" failonerror="true"/>
        <copy file="${source.path}/libopensmtjava-x64.so" tofile="${opensmt.dist.dir}/libopensmtjava-${opensmt.version}.so" failonerror="true"/>

        <ivy:resolve conf="solver-opensmt" file="solvers_ivy_conf/ivy_opensmt.xml"/>
        <publishToRepository solverName="OpenSMT" solverVersion="${opensmt.version}" distDir="${opensmt.dist.dir}"/>
    </target>
</project>
